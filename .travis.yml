language: php

sudo: false
dist: trusty

git:
  depth: 3

notifications:
  email: false
  slack:
    secure: aw6vuUJp0/BZjJd0pi8NehFCcwBdLLSGXlP12cKRFnmm/mPDemI4L+2pEQkvxyo0Mk+A2Rje2tXPURDOE1mKMCbDep0aByrxS7tyXXBZTXfWw42NEEU2AMwRoI1cWXi38aw5A4VyBFSd7gBUIvc1I8EfpaIwAZVaAqR8j+rUHBRk65tmgP3Eo8v6ixjlwwQoVjsBK1WPQsQJsHnTHdPYWmUFsztb+HEOPWgHZiv7fjYWmkyOuZCRo4jpBuPmDGwJYlGZTd7o3nOxt8mT0Mo3lKvC30RHoP0cZKYtBfwp0lZhd91Sz1h97kRes3mXflAUECYt0P6vjZ1GvZr/MwdhzhdrOPfxhBUJYdXheqGeZ3MXxGNe4B6KRaY2GHK/468VzKDJEuJR/pYCWbhxcWvAsrwlqwzvFcRJev/aqbC9rdO6VCDCYG0T4VOodYlNYOEJ1DOaCxBxCWiaNfmXslmD54Q4BdS7RkOotH3s5nJvSFaCNVpXke5wkS6Xrgczw8ChPh7GqBhkmZ9jGc5C8dnYTVD9UJ8lxWmNxzcRgHSizB+x29N5NFsDqmF5YG4dxCczoFiw24BQZpITMn/rvdQLmJHYrgoeWO43acOj27FqHQyekCXxv1hmXo5RdkKK81oPkbIM+fyiXtlwKAnaeHhnLkFUgfh8C8YfFfyAcjrbeeE=

branches:
  only:
    - master
    - "/^v[0-9\\.]+/"

cache:
  yarn: true
  directories:
    - "${HOME}/.composer/cache"
    - node_modules
    - "${TRAVIS_BUILD_DIR}/.plugin"

stages:
  - name: check
    if: branch = master and tag IS blank and type IN (pull_request, api, cron)
  - name: test
    if: branch = master and tag IS blank and type IN (pull_request, api)
  - name: test trunk
    if: branch = master and tag IS blank and type IN (pull_request, api, cron)
  - name: prepare
    if: branch = master and tag IS blank and type IN (pull_request, api)
  - name: deploy
    if: tag IS present

before_script:
  - git clone --depth=1 https://github.com/wp-content-framework/travis-ci.git travis-ci
  - bash travis-ci/bin/prepare.sh

jobs:
  fast_finish: true
  include:
    - stage: check
      language: php
      php: '7.2'
      script: bash travis-ci/bin/php/phpcs.sh
    - stage: check
      language: php
      php: '7.2'
      script: bash travis-ci/bin/php/phpmd.sh

    - stage: check
      language: node_js
      node_js: '11'
      dist: trusty
      script: bash travis-ci/bin/js/js-lint.sh


    - stage: test
      language: php
      php: '7.3'
      env:
        - WP_VERSION=latest
        - COVERAGE_REPORT=1
        - ACTIVATE_POPULAR_PLUGINS=1
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.3'
      env:
        - WP_VERSION=latest
        - WP_MULTISITE=1
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.2'
      env: WP_VERSION=latest
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.2'
      env:
        - WP_VERSION=5.2
        - WP_MULTISITE=1
        - COVERAGE_REPORT=1
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.1'
      env: WP_VERSION=latest
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.1'
      env:
        - WP_VERSION=5.1
        - WP_MULTISITE=1
        - COVERAGE_REPORT=1
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.0'
      env:
        - WP_VERSION=5.0
        - COVERAGE_REPORT=1
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.0'
      env:
        - WP_VERSION=latest
        - WP_MULTISITE=1
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env:
        - WP_VERSION=latest
        - COVERAGE_REPORT=1
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env:
        - WP_VERSION=5.0
        - WP_MULTISITE=1
        - COVERAGE_REPORT=1
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env: WP_VERSION=4.6
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env: WP_VERSION=4.5
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env: WP_VERSION=3.9
      script: bash travis-ci/bin/php/wp-test.sh

    - stage: test
      language: node_js
      node_js: '10'
      dist: trusty
      script: bash travis-ci/bin/js/js-test.sh
    - stage: test
      language: node_js
      node_js: '11'
      dist: trusty
      env: COVERAGE_REPORT=1
      script: bash travis-ci/bin/js/js-test.sh


    - stage: test trunk
      language: php
      php: '7.3'
      env:
        - WP_VERSION=trunk
        - WP_MULTISITE=1
        - ACTIVATE_POPULAR_PLUGINS=1
      script: bash travis-ci/bin/php/wp-test.sh

    - stage: test trunk
      language: php
      php: '5.6'
      env: WP_VERSION=trunk
      script: bash travis-ci/bin/php/wp-test.sh


    - stage: prepare
      language: node_js
      node_js: '11'
      dist: trusty
      script:
        - source travis-ci/bin/deploy/env.sh
        - bash travis-ci/bin/deploy/wp-check-diff.sh


    - stage: deploy
      language: node_js
      node_js: '11'
      dist: trusty
      script: skip
      before_deploy:
        - source travis-ci/bin/deploy/env.sh
        - bash travis-ci/bin/deploy/create.sh
      deploy:
        provider: releases
        skip_cleanup: true
        name: ${RELEASE_TITLE}
        tag_name: ${RELEASE_TAG}
        draft: true
        api_key:
          secure: jbK3igURmIclgLlrbnMukP/c1xFFHoiqGpsQGCg4j1Ka+tki8hmbDn4I74xkW7fF1jpd2IdjhN25XwGd4Ohd8B37p98yRjk57bB29qK4x8ZOXqugBCbdMJ550Bl8GyHO/WB65oEEvK0DUTqFK5KMz415dNfJWquyJ7odwklk2nAi4YR7H7JwDrP1z2AcXhvTiX279qAZ8lxSr78FR/a8enXdLlstSS+awVylRC0MGIJnacbabK8y2rX7JeZU0syX5PDxMC9+N97VKo+rmfFhk6rv0ppCHsNGIlnTsuL5D+cJEGcZuD5Ni0SGEe6sbm8/5H/ztLUjTsc4hNd2DvZFyooBCxwEGd4ivZjllj+7S9k4sutBmVFtBZxVgESGi3cWiqsmkXbdkqFfN/h7wtGuLAf3j3zDk+FMS2kirhfZpDFnoVahblbMfKlVJd6d4KzlXOek7+SgufLPsRFcUMjw4JAqTG73fEzImqz4Mfl34s0njrl4Srfu917JuqyNIXiAJCOTx6RKSjBNq5RsW160bKL7SQLpzKlbvRQ/BmD/A4Dy+QiJNk/c4PgALK78TLiQbXCo7zMcSx/Q5yb1BpbOT8d/pSoMroTSxKYg7d4IflBbO31yZxTbV4tSrmND/9r7sfBYkGq9Eiuk1uX4Nzcl7JDsN4Dn49MoSN2WgAGShn0=
        file: ${RELEASE_FILE}
        overwrite: true
        on:
          tags: true

    - stage: deploy
      language: node_js
      node_js: '11'
      dist: trusty
      script: skip
      before_deploy:
        - source travis-ci/bin/deploy/env.sh
      deploy:
        provider: script
        skip_cleanup: true
        script: bash travis-ci/bin/deploy/wp-release.sh
        on:
          tags: true

  allow_failures:
    - env: WP_VERSION=4.5
    - env: WP_VERSION=3.9
